{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-[#faeee7]">
    <!-- Header -->
    <header class="bg-[#33272a] shadow-lg border-b-4 border-[#ff8ba7]">
        <div class="container mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-[#ff8ba7] rounded-xl shadow-md">
                        <i data-lucide="shield-check" class="w-10 h-10 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Admin Dashboard</h1>
                        <p class="text-[#ffc6c7] text-sm font-medium mt-1">System Administration & Management Portal</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right hidden md:block bg-white/10 px-4 py-2 rounded-lg border border-white/20">
                        <p class="text-white font-bold">{{ user_name }}</p>
                        <p class="text-[#ffc6c7] text-xs font-semibold">ADMINISTRATOR</p>
                    </div>
                    <button onclick="logout()" class="bg-white/10 hover:bg-white/20 text-white font-semibold px-5 py-2.5 rounded-lg transition-colors flex items-center space-x-2 border border-white/20">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Requests -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-[#33272a] hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 bg-[#faeee7] rounded-lg">
                        <i data-lucide="inbox" class="w-6 h-6 text-[#33272a]"></i>
                    </div>
                    <p class="text-4xl font-bold text-[#33272a]">{{ stats.totalRequests }}</p>
                </div>
                <p class="text-[#594a4e] font-semibold">Total Requests</p>
                <p class="text-xs text-[#594a4e] mt-1 opacity-75">All submissions</p>
            </div>

            <!-- Total Staff -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-[#33272a] hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 bg-[#faeee7] rounded-lg">
                        <i data-lucide="users" class="w-6 h-6 text-[#33272a]"></i>
                    </div>
                    <div class="text-right">
                        <p class="text-4xl font-bold text-[#33272a]">{{ stats.totalStaff }}</p>
                        <p class="text-sm font-semibold text-[#c3f0ca] mt-1">{{ stats.activeStaff }} active</p>
                    </div>
                </div>
                <p class="text-[#594a4e] font-semibold">Total Staff</p>
                <p class="text-xs text-[#594a4e] mt-1 opacity-75">Government personnel</p>
            </div>

            <!-- Pending Requests -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-[#ff8ba7] hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 bg-[#ff8ba7]/20 rounded-lg">
                        <i data-lucide="clock" class="w-6 h-6 text-[#ff8ba7]"></i>
                    </div>
                    <p class="text-4xl font-bold text-[#33272a]">{{ stats.pending }}</p>
                </div>
                <p class="text-[#594a4e] font-semibold">Pending</p>
                <p class="text-xs text-[#ff8ba7] mt-1 font-semibold">Requires attention</p>
            </div>

            <!-- Audit Logs -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-[#33272a] hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 bg-[#faeee7] rounded-lg">
                        <i data-lucide="file-text" class="w-6 h-6 text-[#33272a]"></i>
                    </div>
                    <p class="text-4xl font-bold text-[#33272a]">{{ stats.totalAudits }}</p>
                </div>
                <p class="text-[#594a4e] font-semibold">Audit Logs</p>
                <p class="text-xs text-[#594a4e] mt-1 opacity-75">System activities</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
            <div class="border-b-2 border-[#33272a]/10">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button onclick="switchTab('staff')" id="tab-staff" class="tab-button border-b-3 border-[#33272a] text-[#33272a] py-4 px-1 font-bold text-sm bg-[#faeee7]">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>Staff Management</span>
                        </div>
                    </button>
                    <button onclick="switchTab('audit')" id="tab-audit" class="tab-button border-b-3 border-transparent text-[#594a4e] hover:text-[#33272a] hover:bg-[#faeee7] py-4 px-1 font-semibold text-sm">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="activity" class="w-5 h-5"></i>
                            <span>Audit Logs</span>
                        </div>
                    </button>
                    <button onclick="switchTab('system')" id="tab-system" class="tab-button border-b-3 border-transparent text-[#594a4e] hover:text-[#33272a] hover:bg-[#faeee7] py-4 px-1 font-semibold text-sm">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                            <span>System Stats</span>
                        </div>
                    </button>
                </nav>
            </div>

            <!-- Staff Management Tab -->
            <div id="content-staff" class="tab-content p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="p-3 bg-[#33272a] rounded-xl">
                            <i data-lucide="users" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-[#33272a]">Government Staff</h2>
                            <p class="text-[#594a4e] text-sm">Manage personnel and access</p>
                        </div>
                    </div>
                    <button onclick="showAddStaffModal()" class="bg-[#33272a] text-white px-6 py-3 rounded-lg font-bold hover:bg-[#594a4e] transition-all shadow-md flex items-center space-x-2">
                        <i data-lucide="user-plus" class="w-5 h-5"></i>
                        <span>Add Staff Member</span>
                    </button>
                </div>

                <!-- Staff Table -->
                <div class="overflow-x-auto bg-white rounded-xl border border-[#33272a]/10">
                    <table class="min-w-full divide-y divide-[#33272a]/10">
                        <thead class="bg-gradient-to-r from-[#33272a] to-[#594a4e]">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-bold text-white">Staff Member</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-white">Role & Department</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-white">Official ID</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-white">Status</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-white">Added Date</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-white">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody" class="bg-white divide-y divide-[#33272a]/10">
                            {% for staff in staff_list %}
                            <tr class="hover:bg-[#faeee7] transition-colors">
                                <td class="px-6 py-4">
                                    <div class="text-base font-bold text-[#33272a] mb-1">{{ staff.fullName }}</div>
                                    <div class="flex items-center text-sm text-[#594a4e] mb-1">
                                        <i data-lucide="mail" class="w-4 h-4 mr-1"></i>
                                        <span>{{ staff.email }}</span>
                                    </div>
                                    <div class="flex items-center text-sm text-[#594a4e]">
                                        <i data-lucide="phone" class="w-4 h-4 mr-1"></i>
                                        <span>{{ staff.phone if staff.phone else '+1-555-0000' }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-base font-bold text-[#33272a] mb-1">{{ staff.role|capitalize }}</div>
                                    <div class="text-sm text-[#594a4e]">{{ staff.department }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-[#33272a] font-bold bg-[#faeee7] px-3 py-2 rounded-lg inline-block border border-[#33272a]/20">
                                        {{ staff.employeeId }}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1.5 inline-flex text-sm font-bold rounded-lg 
                                        {% if staff.status == 'active' %}bg-[#c3f0ca] text-[#33272a] border border-[#c3f0ca]
                                        {% elif staff.status == 'on-leave' %}bg-[#ffc6c7] text-[#33272a] border border-[#ffc6c7]
                                        {% else %}bg-[#faeee7] text-[#594a4e] border border-[#33272a]/20{% endif %}">
                                        {{ staff.status|capitalize }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center text-sm text-[#33272a] mb-1 font-semibold">
                                        <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                                        <span>{{ staff.addedDate if staff.addedDate else '9/5/2025' }}</span>
                                    </div>
                                    <div class="text-xs text-[#594a4e]">
                                        By: {{ staff.addedBy if staff.addedBy else 'admin@gov.example.com' }}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center space-x-3">
                                        <button onclick='editStaff({{ staff|tojson }})' class="p-2 bg-[#33272a] text-white rounded-lg hover:bg-[#594a4e] transition-colors" title="View Details">
                                            <i data-lucide="eye" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="deleteStaff('{{ staff.id }}')" class="p-2 bg-[#ff8ba7] text-white rounded-lg hover:bg-[#ff8ba7]/80 transition-colors" title="Delete">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Logs Tab -->
            <div id="content-audit" class="tab-content hidden p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="p-3 bg-[#33272a] rounded-xl">
                            <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-[#33272a]">Audit Trail</h2>
                            <p class="text-[#594a4e] text-sm">System activity monitoring</p>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <select id="filterActionType" onchange="filterAuditLogs()" class="px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] text-[#33272a] font-semibold bg-white">
                            <option value="">All Actions</option>
                            <option value="LOGIN">Login</option>
                            <option value="LOGOUT">Logout</option>
                            <option value="CREATE">Create</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                            <option value="STATUS_CHANGE">Status Change</option>
                        </select>
                        <button onclick="loadAuditLogs()" class="bg-[#33272a] text-white px-4 py-2.5 rounded-lg hover:bg-[#594a4e] transition-colors font-semibold shadow-md">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Audit Logs List -->
                <div id="auditLogsList" class="space-y-4">
                    {% for log in recent_audits %}
                    <div class="bg-white rounded-xl p-5 border-l-4 
                        {% if log.action_type == 'CREATE' %}border-[#c3f0ca]
                        {% elif log.action_type == 'UPDATE' %}border-[#33272a]
                        {% elif log.action_type == 'DELETE' %}border-[#ff8ba7]
                        {% elif log.action_type == 'STATUS_CHANGE' %}border-[#ffc6c7]
                        {% else %}border-[#33272a]{% endif %} shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4">
                                <div class="p-3 rounded-xl 
                                    {% if log.action_type == 'CREATE' %}bg-[#c3f0ca]
                                    {% elif log.action_type == 'UPDATE' %}bg-[#33272a]
                                    {% elif log.action_type == 'DELETE' %}bg-[#ff8ba7]
                                    {% elif log.action_type == 'STATUS_CHANGE' %}bg-[#ffc6c7]
                                    {% else %}bg-[#faeee7]{% endif %}">
                                    <i data-lucide="
                                        {% if log.action_type == 'CREATE' %}plus-circle
                                        {% elif log.action_type == 'UPDATE' %}edit
                                        {% elif log.action_type == 'DELETE' %}trash-2
                                        {% elif log.action_type == 'STATUS_CHANGE' %}refresh-cw
                                        {% elif log.action_type == 'LOGIN' %}log-in
                                        {% else %}activity{% endif %}" class="w-6 h-6 
                                        {% if log.action_type == 'UPDATE' or log.action_type == 'DELETE' %}text-white
                                        {% else %}text-[#33272a]{% endif %}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="font-bold text-[#33272a] text-lg">{{ log.action_type }}</span>
                                        {% if log.entity_type %}
                                        <span class="px-3 py-1 bg-[#faeee7] text-[#33272a] text-xs rounded-lg font-semibold border border-[#33272a]/20">{{ log.entity_type }}</span>
                                        {% endif %}
                                        {% if log.entity_id %}
                                        <span class="text-xs text-[#594a4e] font-mono bg-[#faeee7] px-2 py-1 rounded">{{ log.entity_id }}</span>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-[#594a4e] mb-3 leading-relaxed">{{ log.details }}</p>
                                    <div class="flex items-center space-x-4 text-xs text-[#594a4e]">
                                        <span class="flex items-center font-semibold">
                                            <i data-lucide="user" class="w-3 h-3 mr-1"></i>
                                            {{ log.user_email }}
                                        </span>
                                        <span class="flex items-center">
                                            <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                            {{ log.timestamp }}
                                        </span>
                                        {% if log.ip_address %}
                                        <span class="flex items-center">
                                            <i data-lucide="wifi" class="w-3 h-3 mr-1"></i>
                                            {{ log.ip_address }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- System Stats Tab -->
            <div id="content-system" class="tab-content hidden p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="p-3 bg-[#33272a] rounded-xl">
                        <i data-lucide="bar-chart-2" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-[#33272a]">System Statistics</h2>
                        <p class="text-[#594a4e] text-sm">Comprehensive system analytics</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Request Status Breakdown -->
                    <div class="bg-white rounded-xl p-6 border-l-4 border-[#33272a] shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="p-2.5 bg-[#faeee7] rounded-xl">
                                <i data-lucide="pie-chart" class="w-6 h-6 text-[#33272a]"></i>
                            </div>
                            <h3 class="text-lg font-bold text-[#33272a]">Request Status</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm font-semibold text-[#594a4e]">Pending</span>
                                    <span class="text-sm font-bold text-[#33272a]">{{ stats.pending }}</span>
                                </div>
                                <div class="w-full bg-[#faeee7] rounded-full h-3 overflow-hidden border border-[#33272a]/10">
                                    <div class="bg-gradient-to-r from-[#ffc6c7] to-[#ff8ba7] h-3 rounded-full transition-all duration-300" style="width: {{ (stats.pending / stats.totalRequests * 100) if stats.totalRequests > 0 else 0 }}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm font-semibold text-[#594a4e]">In Progress</span>
                                    <span class="text-sm font-bold text-[#33272a]">{{ stats.inProgress }}</span>
                                </div>
                                <div class="w-full bg-[#faeee7] rounded-full h-3 overflow-hidden border border-[#33272a]/10">
                                    <div class="bg-gradient-to-r from-[#33272a] to-[#594a4e] h-3 rounded-full transition-all duration-300" style="width: {{ (stats.inProgress / stats.totalRequests * 100) if stats.totalRequests > 0 else 0 }}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm font-semibold text-[#594a4e]">Completed</span>
                                    <span class="text-sm font-bold text-[#33272a]">{{ stats.completed }}</span>
                                </div>
                                <div class="w-full bg-[#faeee7] rounded-full h-3 overflow-hidden border border-[#33272a]/10">
                                    <div class="bg-gradient-to-r from-[#c3f0ca] to-[#c3f0ca]/80 h-3 rounded-full transition-all duration-300" style="width: {{ (stats.completed / stats.totalRequests * 100) if stats.totalRequests > 0 else 0 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Critical Metrics -->
                    <div class="bg-white rounded-xl p-6 border-l-4 border-[#ff8ba7] shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="p-2.5 bg-[#ffc6c7]/30 rounded-xl">
                                <i data-lucide="alert-circle" class="w-6 h-6 text-[#ff8ba7]"></i>
                            </div>
                            <h3 class="text-lg font-bold text-[#33272a]">Critical Metrics</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 bg-[#faeee7] rounded-xl border border-[#33272a]/10 hover:border-[#33272a]/30 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2.5 bg-white rounded-lg shadow-sm">
                                        <i data-lucide="alert-triangle" class="w-5 h-5 text-[#ff8ba7]"></i>
                                    </div>
                                    <span class="text-sm font-semibold text-[#594a4e]">Critical Requests</span>
                                </div>
                                <span class="text-2xl font-bold text-[#33272a]">{{ stats.criticalRequests }}</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-[#faeee7] rounded-xl border border-[#33272a]/10 hover:border-[#33272a]/30 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2.5 bg-white rounded-lg shadow-sm">
                                        <i data-lucide="graduation-cap" class="w-5 h-5 text-[#33272a]"></i>
                                    </div>
                                    <span class="text-sm font-semibold text-[#594a4e]">Student Requests</span>
                                </div>
                                <span class="text-2xl font-bold text-[#33272a]">{{ stats.studentRequests }}</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-[#faeee7] rounded-xl border border-[#33272a]/10 hover:border-[#33272a]/30 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2.5 bg-white rounded-lg shadow-sm">
                                        <i data-lucide="clock" class="w-5 h-5 text-[#c3f0ca]"></i>
                                    </div>
                                    <span class="text-sm font-semibold text-[#594a4e]">Avg Response Time</span>
                                </div>
                                <span class="text-2xl font-bold text-[#33272a]">{{ stats.avgResponseTime }} hrs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Staff Modal -->
<div id="staffModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 bg-gradient-to-r from-[#33272a] to-[#594a4e]">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-2xl font-bold text-white" id="modalTitle">Add New Staff Member</h3>
                    <p class="text-sm text-white/80 mt-1">Fill in the details to add a new staff member to the system</p>
                </div>
                <button onclick="closeStaffModal()" class="text-white/80 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        
        <form id="staffForm" class="p-6 space-y-6">
            <input type="hidden" id="staffId">
            
            <!-- Personal Information Section -->
            <div>
                <div class="flex items-center space-x-2 mb-4">
                    <div class="p-2 bg-[#33272a] rounded-lg">
                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                    </div>
                    <h4 class="text-lg font-bold text-[#33272a]">Personal Information</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Full Name *</label>
                        <input type="text" id="staffFullName" required placeholder="John Doe" class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Email Address *</label>
                        <input type="email" id="staffEmail" required placeholder="john.doe@gov.com" class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Phone Number *</label>
                        <input type="tel" id="staffPhone" required placeholder="+1-555-0000" class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Official ID *</label>
                        <input type="text" id="staffEmployeeId" required placeholder="GOV-12345" class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Password *</label>
                        <div class="relative">
                            <input type="password" id="staffPassword" required placeholder="Enter secure password" class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent pr-10">
                            <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-[#594a4e] hover:text-[#33272a]">
                                <i data-lucide="eye" id="passwordToggleIcon" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-xs text-[#594a4e] mt-1">Minimum 8 characters, include letters and numbers</p>
                    </div>
                </div>
            </div>

            <!-- Role & Department Section -->
            <div>
                <div class="flex items-center space-x-2 mb-4">
                    <div class="p-2 bg-[#33272a] rounded-lg">
                        <i data-lucide="briefcase" class="w-5 h-5 text-white"></i>
                    </div>
                    <h4 class="text-lg font-bold text-[#33272a]">Role & Department</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Department *</label>
                        <select id="staffDepartment" required class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent">
                            <option value="">Select Department</option>
                            <option value="Social Services">Social Services</option>
                              <option value="Infrastructure & Housing">Infrastructure & Housing</option>
                             <option value="Emergency Services">Emergency Services</option>
                            <option value="Relief Operations">Relief Operations</option>
                            <option value="Health and Medical Services">Health and Medical Services</option>
                            <option value="Educational Support">Educational Support</option>
                            <option value="Financial Assistance">Financial Assistance</option>
                            <option value="Administration">Administration</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-[#33272a] mb-2">Role *</label>
                        <select id="staffRole" required class="w-full px-4 py-2.5 border-2 border-[#33272a]/20 rounded-lg focus:ring-2 focus:ring-[#33272a] focus:border-transparent">
                            <option value="">Select Role</option>
                            <option value="officer">Officer</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                            <option value="coordinator">Coordinator</option>
                            <option value="analyst">Analyst</option>
                            <option value="support">Support</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Permissions Section -->
            <div>
                <div class="flex items-center space-x-2 mb-4">
                    <div class="p-2 bg-[#33272a] rounded-lg">
                        <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                    </div>
                    <h4 class="text-lg font-bold text-[#33272a]">Permissions</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-[#faeee7] p-5 rounded-xl border border-[#33272a]/10">
                    <div class="flex items-center p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permViewRequests" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permViewRequests" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">View Requests</label>
                    </div>
                    
                    <div class="flex items-center p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permManageRequests" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permManageRequests" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">Manage Requests</label>
                    </div>
                    
                    <div class="flex items-center p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permAssignRequests" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permAssignRequests" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">Assign Requests</label>
                    </div>
                    
                    <div class="flex items-center p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permViewAnalytics" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permViewAnalytics" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">View Analytics</label>
                    </div>
                    
                    <div class="flex items-center p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permManageStaff" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permManageStaff" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">Manage Staff</label>
                    </div>
                    
                    <div class="flex items-center p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permViewAuditLogs" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permViewAuditLogs" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">View Audit Logs</label>
                    </div>
                    
                    <div class="flex items-center md:col-span-2 p-2 hover:bg-white rounded-lg transition-colors">
                        <input type="checkbox" id="permSystemSettings" class="w-4 h-4 text-[#33272a] border-[#33272a]/30 rounded focus:ring-[#33272a]">
                        <label for="permSystemSettings" class="ml-3 text-sm font-semibold text-[#594a4e] cursor-pointer">System Settings</label>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-6 border-t-2 border-[#33272a]/10">
                <button type="button" onclick="clearStaffForm()" class="px-6 py-2.5 border-2 border-[#33272a]/20 rounded-lg text-[#594a4e] hover:bg-[#faeee7] hover:text-[#33272a] transition-all font-semibold">
                    Clear Form
                </button>
                <button type="submit" class="px-8 py-2.5 bg-[#33272a] text-white rounded-lg hover:bg-[#594a4e] transition-all shadow-lg font-semibold">
                    Add Staff Member
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentEditStaffId = null;

    // Tab switching
    function switchTab(tab) {
        // Hide all content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Remove active state from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-[#33272a]', 'text-[#33272a]', 'font-bold', 'bg-[#faeee7]');
            button.classList.add('border-transparent', 'text-[#594a4e]', 'font-semibold');
        });
        
        // Show selected content
        document.getElementById(`content-${tab}`).classList.remove('hidden');
        
        // Activate selected tab
        const activeTab = document.getElementById(`tab-${tab}`);
        activeTab.classList.remove('border-transparent', 'text-[#594a4e]', 'font-semibold');
        activeTab.classList.add('border-[#33272a]', 'text-[#33272a]', 'font-bold', 'bg-[#faeee7]');
        
        // Load data if needed
        if (tab === 'audit') {
            loadAuditLogs();
        }
        
        lucide.createIcons();
    }

    // Staff Management Functions
    function showAddStaffModal() {
        currentEditStaffId = null;
        document.getElementById('modalTitle').textContent = 'Add New Staff Member';
        const subtitle = document.querySelector('#staffModal p.text-sm');
        if (subtitle) subtitle.textContent = 'Fill in the details to add a new staff member to the system';
        document.getElementById('staffForm').reset();
        document.getElementById('staffId').value = '';
        
        // Show password field for new staff
        const passwordField = document.getElementById('staffPassword').closest('div.md\\:col-span-2');
        if (passwordField) passwordField.style.display = 'block';
        
        // Reset all permission checkboxes
        document.getElementById('permViewRequests').checked = false;
        document.getElementById('permManageRequests').checked = false;
        document.getElementById('permAssignRequests').checked = false;
        document.getElementById('permViewAnalytics').checked = false;
        document.getElementById('permManageStaff').checked = false;
        document.getElementById('permViewAuditLogs').checked = false;
        document.getElementById('permSystemSettings').checked = false;
        
        document.getElementById('staffModal').classList.remove('hidden');
        lucide.createIcons();
    }

    function editStaff(staff) {
        currentEditStaffId = staff.id;
        document.getElementById('modalTitle').textContent = 'Edit Staff Member';
        const subtitle = document.querySelector('#staffModal p.text-sm');
        if (subtitle) subtitle.textContent = 'Update the staff member information';
        
        document.getElementById('staffId').value = staff.id;
        document.getElementById('staffFullName').value = staff.fullName;
        document.getElementById('staffEmail').value = staff.email;
        document.getElementById('staffPhone').value = staff.phone;
        document.getElementById('staffEmployeeId').value = staff.employeeId;
        document.getElementById('staffDepartment').value = staff.department;
        document.getElementById('staffRole').value = staff.role;
        
        // Hide password field when editing
        const passwordField = document.getElementById('staffPassword').closest('div.md\\:col-span-2');
        if (passwordField) passwordField.style.display = 'none';
        
        // Set permissions if available
        if (staff.permissions) {
            document.getElementById('permViewRequests').checked = staff.permissions.viewRequests || false;
            document.getElementById('permManageRequests').checked = staff.permissions.manageRequests || false;
            document.getElementById('permAssignRequests').checked = staff.permissions.assignRequests || false;
            document.getElementById('permViewAnalytics').checked = staff.permissions.viewAnalytics || false;
            document.getElementById('permManageStaff').checked = staff.permissions.manageStaff || false;
            document.getElementById('permViewAuditLogs').checked = staff.permissions.viewAuditLogs || false;
            document.getElementById('permSystemSettings').checked = staff.permissions.systemSettings || false;
        }
        
        document.getElementById('staffModal').classList.remove('hidden');
        lucide.createIcons();
    }

    function closeStaffModal() {
        document.getElementById('staffModal').classList.add('hidden');
    }

    function clearStaffForm() {
        document.getElementById('staffForm').reset();
        // Reset all permission checkboxes
        document.getElementById('permViewRequests').checked = false;
        document.getElementById('permManageRequests').checked = false;
        document.getElementById('permAssignRequests').checked = false;
        document.getElementById('permViewAnalytics').checked = false;
        document.getElementById('permManageStaff').checked = false;
        document.getElementById('permViewAuditLogs').checked = false;
        document.getElementById('permSystemSettings').checked = false;
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('staffPassword');
        const toggleIcon = document.getElementById('passwordToggleIcon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.setAttribute('data-lucide', 'eye-off');
        } else {
            passwordInput.type = 'password';
            toggleIcon.setAttribute('data-lucide', 'eye');
        }
        lucide.createIcons();
    }

    document.getElementById('staffForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const staffData = {
            fullName: document.getElementById('staffFullName').value,
            email: document.getElementById('staffEmail').value,
            phone: document.getElementById('staffPhone').value,
            employeeId: document.getElementById('staffEmployeeId').value,
            department: document.getElementById('staffDepartment').value,
            role: document.getElementById('staffRole').value,
            permissions: {
                viewRequests: document.getElementById('permViewRequests').checked,
                manageRequests: document.getElementById('permManageRequests').checked,
                assignRequests: document.getElementById('permAssignRequests').checked,
                viewAnalytics: document.getElementById('permViewAnalytics').checked,
                manageStaff: document.getElementById('permManageStaff').checked,
                viewAuditLogs: document.getElementById('permViewAuditLogs').checked,
                systemSettings: document.getElementById('permSystemSettings').checked
            }
        };
        
        // Add password only for new staff members
        if (!currentEditStaffId) {
            const password = document.getElementById('staffPassword').value;
            if (!password || password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }
            staffData.password = password;
        }
        
        try {
            let response;
            if (currentEditStaffId) {
                // Update existing staff
                response = await fetch(`/api/admin/staff/${currentEditStaffId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(staffData)
                });
            } else {
                // Create new staff
                response = await fetch('/api/admin/staff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(staffData)
                });
            }
            
            if (response.ok) {
                closeStaffModal();
                location.reload(); // Reload to show updated staff list
            } else {
                const errorData = await response.json();
                alert(errorData.message || 'Error saving staff member');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving staff member');
        }
    });

    async function deleteStaff(staffId) {
        if (confirm('Are you sure you want to deactivate this staff member?')) {
            try {
                const response = await fetch(`/api/admin/staff/${staffId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deactivating staff member');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deactivating staff member');
            }
        }
    }

    // Audit Log Functions
    async function loadAuditLogs() {
        const actionType = document.getElementById('filterActionType')?.value || '';
        
        try {
            const params = new URLSearchParams();
            if (actionType) params.append('action_type', actionType);
            params.append('limit', '50');
            
            const response = await fetch(`/api/admin/audit-logs?${params}`);
            const data = await response.json();
            
            if (data.success) {
                displayAuditLogs(data.logs);
            }
        } catch (error) {
            console.error('Error loading audit logs:', error);
        }
    }

    function displayAuditLogs(logs) {
        const container = document.getElementById('auditLogsList');
        
        if (logs.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">No audit logs found</p>';
            return;
        }
        
        container.innerHTML = logs.map(log => `
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-3">
                        <div class="p-2 rounded-full ${getActionColor(log.action_type).bg}">
                            <i data-lucide="${getActionIcon(log.action_type)}" class="w-5 h-5 ${getActionColor(log.action_type).text}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-semibold text-gray-900">${log.action_type}</span>
                                ${log.entity_type ? `<span class="px-2 py-0.5 bg-gray-200 text-gray-700 text-xs rounded">${log.entity_type}</span>` : ''}
                                ${log.entity_id ? `<span class="text-xs text-gray-500">${log.entity_id}</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${log.details}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span class="flex items-center">
                                    <i data-lucide="user" class="w-3 h-3 mr-1"></i>
                                    ${log.user_email}
                                </span>
                                <span class="flex items-center">
                                    <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                    ${new Date(log.timestamp).toLocaleString()}
                                </span>
                                ${log.ip_address ? `<span class="flex items-center"><i data-lucide="wifi" class="w-3 h-3 mr-1"></i>${log.ip_address}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        lucide.createIcons();
    }

    function getActionIcon(actionType) {
        const icons = {
            'CREATE': 'plus-circle',
            'UPDATE': 'edit',
            'DELETE': 'trash-2',
            'STATUS_CHANGE': 'refresh-cw',
            'LOGIN': 'log-in',
            'LOGOUT': 'log-out'
        };
        return icons[actionType] || 'activity';
    }

    function getActionColor(actionType) {
        const colors = {
            'CREATE': { bg: 'bg-green-100', text: 'text-green-600' },
            'UPDATE': { bg: 'bg-blue-100', text: 'text-blue-600' },
            'DELETE': { bg: 'bg-red-100', text: 'text-red-600' },
            'STATUS_CHANGE': { bg: 'bg-yellow-100', text: 'text-yellow-600' },
            'LOGIN': { bg: 'bg-purple-100', text: 'text-purple-600' },
            'LOGOUT': { bg: 'bg-gray-100', text: 'text-gray-600' }
        };
        return colors[actionType] || { bg: 'bg-gray-100', text: 'text-gray-600' };
    }

    function filterAuditLogs() {
        loadAuditLogs();
    }

    // Logout
    async function logout() {
        try {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    // Initialize
    lucide.createIcons();
</script>
{% endblock %}
